<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="shared-styles.html">

<dom-module id="my-view2">
    <template is="dom-bind">
        <style include="shared-styles" is="custom-style">
            :host {
                display: block;
                padding: 10px;
            }

            .big-icon {
                --iron-icon-width: 100px;
                --iron-icon-height: 100px;
            }

            .flex-horizontal-with-ratios {
                @apply(--layout-horizontal);
            }

            .flexchild {
                @apply(--layout-flex-3);
            }

            .flexchild2 {
                @apply(--layout-flex-2);
            }

            .flex-center {
                @apply(--layout-horizontal);
                @apply(--layout-center-justified);
            }

            #toggleDialog {
                width: 550px;
            }

            a:link, a:visited {
                color: inherit;
            }

            iron-icon:hover {
                color: red;
                cursor: pointer;
            }

            vaadin-grid {
                font: 500 13px "Open Sans", sans-serif;
                --divider-color: rgb(223, 232, 239);

                --vaadin-grid-cell: {
                    padding: 0 13px;
                };

                --vaadin-grid-body-cell: {
                    height: 65px;
                };

                --vaadin-grid-header-cell: {
                    background: rgba(235, 238, 246, 0.9);
                    border-bottom: 1px solid rgba(208, 217, 225, 0.9);
                    border-top: 1px solid rgba(248, 250, 252, 0.9);
                    min-height: 35px;

                    background-image: linear-gradient(rgba(108, 160, 218, 0), rgba(108, 160, 218, 0.15));
                    background-size: 1px 100%;
                    background-position: 100% 0%;
                    background-repeat: no-repeat;
                };

                --vaadin-grid-body-row-selected-cell: {
                    background-color: rgb(131, 183, 236);
                    border-bottom-color: rgb(108, 160, 218);
                };

                --vaadin-grid-body-row-odd-cell: {
                    background-color: rgb(251, 252, 254);
                };

                --vaadin-grid-body-row-hover-cell: {
                    background-color: rgb(235, 238, 246);
                };

                --vaadin-grid-body-row-details-cell: {
                    text-align: center;
                };

                --vaadin-grid-column-resize-handle: {
                    opacity: 0;
                };
            }

            vaadin-grid-filter, paper-input {
                width: 100%;
            }

        </style>
        <div class="card">
            <div class="circle">2</div>
            <h1>Compartidos</h1>
            <iron-ajax auto
                       url="[[backendUrl]]/fileAccess/sharedWith/[[username]]"
                       handle-as="json"
                       on-response="handleResponse"
                       debounce-duration="300"></iron-ajax>
            <template is="dom-if" if="[[ajaxError]]">
                <span>Error in url</span>
            </template>
            <vaadin-grid id="grid" items="[[ajaxResponse]]" active-item="{{activeItem}}" multi-sort
                         on-active-item-changed="_activeItemChanged">
                <vaadin-grid-column width="300px">
                    <template class="header">
                        <vaadin-grid-sorter path="name">
                            <vaadin-grid-filter path="name" value="[[filterName]]">
                                <paper-input placeholder="Nombre" value="{{filterName}}" focus-target></paper-input>
                            </vaadin-grid-filter>
                        </vaadin-grid-sorter>
                    </template>
                    <template>[[item.name]]</template>
                </vaadin-grid-column>
                <vaadin-grid-column width="150px">
                    <template class="header">
                        <vaadin-grid-sorter path="extension">
                            <vaadin-grid-filter path="extension" value="[[filterExtension]]">
                                <vaadin-combo-box label="Extensi칩n"
                                                  value="{{filterExtension}}"
                                                  items="[[extensionsArray]]"
                                                  allow-custom-value></vaadin-combo-box>
                            </vaadin-grid-filter>
                        </vaadin-grid-sorter>
                    </template>
                    <template>[[item.extension]]</template>
                </vaadin-grid-column>
                <vaadin-grid-column width="150px">
                    <template class="header">
                        <vaadin-grid-sorter path="size">
                            <vaadin-grid-filter path="size" value="[[filterSize]]">
                                <paper-input placeholder="Tama침o(Kb)" value="{{filterSize}}"
                                             focus-target></paper-input>
                            </vaadin-grid-filter>
                        </vaadin-grid-sorter>
                    </template>
                    <template>[[item.size]]</template>
                </vaadin-grid-column>
                <vaadin-grid-column width="150px">
                    <template class="header">
                        <vaadin-grid-sorter path="name">
                            <vaadin-grid-filter path="owner_id" value="[[filterOwner]]">
                                <paper-input placeholder="Due침o" value="{{filterOwner}}" focus-target></paper-input>
                            </vaadin-grid-filter>
                        </vaadin-grid-sorter>
                    </template>
                    <template>[[item.owner_id]]</template>
                </vaadin-grid-column>
                <vaadin-grid-column width="150px">
                    <template class="header">
                        <vaadin-grid-sorter path="expiring_date">
                            <vaadin-grid-filter path="expiring_date" value="[[filterExpiringDate]]">
                                <paper-input placeholder="Vencimiento" value="{{filterExpiringDate}}"
                                             focus-target></paper-input>
                            </vaadin-grid-filter>
                        </vaadin-grid-sorter>
                    </template>
                    <template>[[item.expiring_date]]</template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">Descarga</template>
                    <template>
                        <a href="[[backendUrl]]/fileAccess/download/[[item._id]]/[[username]]"
                           target="_blank">
                            <iron-icon icon="file-download"></iron-icon>
                        </a>
                    </template>
                </vaadin-grid-column>
                <vaadin-grid-column>
                    <template class="header">Detalles</template>
                    <template>
                        <iron-icon icon="info" on-click="handleToggle"></iron-icon>
                    </template>
                </vaadin-grid-column>
            </vaadin-grid>
            <paper-dialog id="toggleDialog">
                <h2>Detalles del archivo</h2>
                <paper-dialog-scrollable>
                    <div class="container flex-horizontal-with-ratios">
                        <div class="flexchild">
                            <div>
                                <div><b>Nombre</b></div>
                                <p>[[activeItem.name]]</p>
                            </div>
                            <div>
                                <div><b>Extension</b></div>
                                <p>[[activeItem.extension]]</p>
                            </div>
                            <div>
                                <div><b>Tama침o (Kb)</b></div>
                                <p>[[activeItem.size]]</p>
                            </div>
                            <div>
                                <div><b>Fecha vencimiento</b></div>
                                <p>[[activeItem.expiring_date]]</p>
                            </div>
                        </div>
                        <div class="flexchild2">
                            <div class="flex-center">
                                <a download="[[activeItem.name]]"
                                   href="[[backendUrl]]/fileAccess/download/[[activeItem._id]]/[[username]]">
                                    <iron-icon icon="file-download" class="big-icon"></iron-icon>
                                </a>
                            </div>
                            <div>
                                <div><b>Checksum</b></div>
                                <p>[[activeItem.md5]]</p>
                            </div>
                        </div>
                    </div>
                </paper-dialog-scrollable>
                <div class="buttons">
                    <paper-button dialog-confirm>Cerrar</paper-button>
                </div>
            </paper-dialog>
        </div>
    </template>

    <script>
      Polymer({
        is: 'my-view2',
        properties: {
          backendUrl: {
            type: String,
          },
          username: {
            type: String,
            value: 'lachaparrog@unal.edu.co',
          },
          extensionsArray: {
            type: Array,
            value: [],
          },
          ajaxResponse: Object,
          ajaxError: Object,
        },
        handleResponse: function (data) {
          var response = data.detail.response.shared_documents;
          this.ajaxResponse = response.map(function (item) {
            item.size = (item.size / 1000 ).toFixed(3);
            var auxDate = new Date(item.expiring_date * 1000);
            item.expiring_date = auxDate.toISOString().split('T')[0];
            return item;
          });
          var extensions = this.ajaxResponse.reduce(function (current, item) {
            if (item.extension !== '') {
              current[item.extension] = true;
            }
            return current;
          }, {});
          this.extensionsArray = Object.keys(extensions);
          this.$.grid.clearCache();
        },
        handleToggle: function () {
          this.$.toggleDialog.toggle();
        },
        _activeItemChanged: function () {
          this._clickedItem = this.$.grid.activeItem || this._clickedItem;
          if (this.$.grid.activeItem === null && this._clickedItem !== null) {
            this.$.grid.activeItem = this._clickedItem;
          }
        },
      });
    </script>
</dom-module>
