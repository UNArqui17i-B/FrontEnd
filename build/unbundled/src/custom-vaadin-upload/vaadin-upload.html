<html><head><link rel="import" href="../../bower_components/polymer/polymer.html"><link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html"><link rel="import" href="../../bower_components/paper-styles/typography.html"><link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html"><link rel="import" href="../../bower_components/paper-button/paper-button.html"><link rel="import" href="vaadin-upload-icons.html"><link rel="import" href="vaadin-upload-file.html"></head><body><dom-module id="vaadin-upload"><template><style>:host{@apply (--layout-vertical);display:block;position:relative;text-align:left;}:host(:not([nodrop])){border:1px dashed;border-color:var(--divider-color, #666);border-radius:3px;overflow:hidden;padding:16px;}:host([dragover-valid]){border-color:var(--primary-color, #00B4F0);}:host::before{@apply (--layout-fit);content:'';display:none;z-index:10;}:host([dragover])::before{display:block;}#dragRipple{color:var(--light-primary-color, #7CD8F7);@apply (--vaadin-upload-drag-ripple);}#dropLabel{@apply (--layout-flex);@apply (--paper-font-body2);position:relative;padding:.43em .57em;margin:0 .29em;color:var(--disabled-text-color, #b3b3b3);@apply (--vaadin-upload-drop-label);}:host([dragover-valid]) #dropLabel,
      :host([dragover-valid]) ::content .drop-label{color:var(--primary-color, #00B4F0);@apply (--vaadin-upload-drop-label-dragover);}#dropLabel ::content iron-icon{margin-right:.25em;@apply (--vaadin-upload-drop-label-icon);}#fileList{position:relative;@apply (--vaadin-upload-file-list);}#buttons{@apply (--layout-horizontal);position:relative;@apply (--vaadin-upload-buttons);}#buttonsPrimary{@apply (--layout-horizontal);@apply (--layout-flex);@apply (--layout-start);margin-left:-.29em;@apply (--vaadin-upload-buttons-primary);}#addFiles{@apply (--vaadin-upload-button-add-wrapper);}#addButton{@apply (--paper-font-button);padding:.43em .57em;background:var(--app-primary-color, #00B4F0);color:var(--primary-font-color, #FFF);@apply (--vaadin-upload-button-add);}#addButton[disabled]{background:var(--divider-color, #e0e0e0);color:var(--disabled-text-color, gray);@apply (--vaadin-upload-button-add-disabled);}</style><div id="buttons"><div id="buttonsPrimary"><div id="addFiles" on-tap="_onAddFilesClick"><slot name="add-button"><paper-button id="addButton" disabled$="[[maxFilesReached]]">[[_i18nPlural(maxFiles, i18n.addFiles, i18n.addFiles.*)]]</paper-button></slot></div><div id="dropLabel" hidden$="[[nodrop]]"><content select=".drop-label"><iron-icon icon="vaadin-upload:file-upload"></iron-icon>[[_i18nPlural(maxFiles, i18n.dropFiles, i18n.dropFiles.*)]]</content></div></div></div><content select=".file-list"><div id="fileList"><template is="dom-repeat" items="[[files]]" as="file"><vaadin-upload-file file="[[file]]"></vaadin-upload-file></template></div></content><content></content><input type="file" id="fileInput" on-change="_onFileInputChange" hidden="" accept$="{{accept}}" multiple$="[[_isMultiple(maxFiles)]]"><paper-ripple id="dragRipple" noink=""></paper-ripple></template></dom-module><script>Polymer({is:'vaadin-upload',properties:{nodrop:{type:Boolean,reflectToAttribute:!0,value:function(){try{return!!document.createEvent('TouchEvent')}catch(a){return!1}}},target:{type:String,value:''},method:{type:String,value:'POST'},headers:{type:Object,value:{}},timeout:{type:Number,value:0},_dragover:{type:Boolean,value:!1,observer:'_dragoverChanged'},files:{type:Array,notify:!0,value:function(){return[]}},maxFiles:{type:Number,value:Infinity},maxFilesReached:{type:Boolean,value:!1,notify:!0,readOnly:!0,computed:'_maxFilesAdded(maxFiles, files.length)'},accept:{type:String,value:''},maxFileSize:{type:Number,value:Infinity},_dragoverValid:{type:Boolean,value:!1,observer:'_dragoverValidChanged'},formDataName:{type:String,value:'file'},noAuto:{type:Boolean,value:!1},i18n:{type:Object,value:function(){return{dropFiles:{one:'Drop file here...',many:'Drop files here...'},addFiles:{one:'Select File',many:'Upload Files'},cancel:'Cancel',error:{tooManyFiles:'Too Many Files.',fileIsTooBig:'File is Too Big.',incorrectFileType:'Incorrect File Type.'},uploading:{status:{connecting:'Connecting...',stalled:'Stalled.',processing:'Processing File...',held:'Queued'},remainingTime:{prefix:'remaining time: ',unknown:'unknown remaining time'},error:{serverUnavailable:'Server Unavailable',unexpectedServerError:'Unexpected Server Error',forbidden:'Forbidden'}},units:{size:['B','kB','MB','GB','TB','PB','EB','ZB','YB']}}}}},listeners:{dragover:'_onDragover',dragleave:'_onDragleave',drop:'_onDrop','file-retry':'_onFileRetry','file-abort':'_onFileAbort','file-remove':'_onFileRemove'},_formatSize:function(a){if('function'===typeof this.i18n.formatSize)return this.i18n.formatSize(a);var b=this.i18n.units.sizeBase||1e3,c=~~(Math.log(a)/Math.log(b)),d=Math.max(0,Math.min(3,c-1)),f=parseFloat((a/Math.pow(b,c)).toFixed(d));return f+' '+this.i18n.units.size[c]},_splitTimeByUnits:function(a){for(var b=[60,60,24,Infinity],c=[0],d=0;d<b.length&&0<a;d++)c[d]=a%b[d],a=Math.floor(a/b[d]);return c},_formatTime:function(a,b){if('function'===typeof this.i18n.formatTime)return this.i18n.formatTime(a,b);for(;3>b.length;)b.push(0);return b.reverse().map(function(c){return(10>c?'0':'')+c}).join(':')},_formatFileProgress:function(a){return a.totalStr+': '+a.progress+'% ('+(0<a.loaded?this.i18n.uploading.remainingTime.prefix+a.remainingStr:this.i18n.uploading.remainingTime.unknown)+')'},_maxFilesAdded:function(a,b){return 0<=a&&b>=a},_dragRippleAction:function(a,b){var c={detail:{x:b.clientX,y:b.clientY}};if('down'===a){this.$.dragRipple.downAction(c);var d=this.$.dragRipple.ripples[this.$.dragRipple.ripples.length-1];d.hasOwnProperty('radius')||Object.defineProperty(d,'radius',{get:function(){var f=this.containerMetrics.width*this.containerMetrics.width,g=this.containerMetrics.height*this.containerMetrics.height,h=1.1*Math.sqrt(f+g)+5,k=this.mouseInteractionSeconds/(0.9+0.2*(h/300)),l=h*(1-Math.pow(80,-k));return Math.abs(l)}})}else this.$.dragRipple.upAction(c)},_onDragover:function(a){a.preventDefault(),this.nodrop||this._dragover||(this._dragoverValid=!this.maxFilesReached,this._dragoverValid&&this._dragRippleAction('down',a),this._dragover=!0),a.dataTransfer.dropEffect=!this._dragoverValid||this.nodrop?'none':'copy'},_onDragleave:function(a){Polymer.dom(a).rootTarget===this&&(a.preventDefault(),this._dragover&&!this.nodrop&&(this._dragRippleAction('up',a),this._dragover=this._dragoverValid=!1))},_onDrop:function(a){this.nodrop||(a.preventDefault(),this._dragRippleAction('up',a),this._dragover=this._dragoverValid=!1,this._dragRippleAction('upAction',a),this._addFiles(a.dataTransfer.files))},_createXhr:function(){return new XMLHttpRequest},_configureXhr:function(a){if('string'===typeof this.headers)try{this.headers=JSON.parse(this.headers)}catch(c){this.headers=void 0}for(var b in this.headers)this.headers.hasOwnProperty(b)&&a.setRequestHeader(b,this.headers[b]);this.timeout&&(a.timeout=this.timeout)},_setStatus:function(a,b,c,d){a.elapsed=d,a.elapsedStr=this._formatTime(a.elapsed,this._splitTimeByUnits(a.elapsed)),a.remaining=Math.ceil(d*(b/c-1)),a.remainingStr=this._formatTime(a.remaining,this._splitTimeByUnits(a.remaining)),a.speed=~~(b/d/1024),a.totalStr=this._formatSize(b),a.loadedStr=this._formatSize(c),a.status=this._formatFileProgress(a)},uploadFiles:function(a){a=a||this.files,a=a.filter(function(b){return!b.complete}),Array.prototype.forEach.call(a,this._uploadFile.bind(this))},_uploadFile:function(a){if(!a.uploading){var d,f,b=Date.now(),c=a.xhr=this._createXhr(a);c.upload.onprogress=function(j){clearTimeout(d),f=Date.now();var k=(f-b)/1e3,l=j.loaded,m=j.total,n=~~(100*(l/m));a.loaded=l,a.progress=n,a.indeterminate=0>=l||l>=m,!0,a.error?a.indeterminate=a.status=void 0:!a.abort&&(100>n?(this._setStatus(a,m,l,k,n),d=setTimeout(function(){a.status=this.i18n.uploading.status.stalled,this._notifyFileChanges(a)}.bind(this),2e3)):(a.loadedStr=a.totalStr,a.status=this.i18n.uploading.status.processing,a.uploading=!1)),this._notifyFileChanges(a),this.fire('upload-progress',{file:a,xhr:c})}.bind(this),c.onreadystatechange=function(){if(4==c.readyState){if(clearTimeout(d),a.indeterminate=a.uploading=!1,a.abort)return void this._notifyFileChanges(a);a.status='';var j=this.fire('upload-response',{file:a,xhr:c},{cancelable:!0});if(j.defaultPrevented)return;0===c.status?a.error=this.i18n.uploading.error.serverUnavailable:500<=c.status?a.error=this.i18n.uploading.error.unexpectedServerError:400<=c.status&&(a.error=this.i18n.uploading.error.forbidden),a.complete=!a.error,this.fire('upload-'+(a.error?'error':'success'),{file:a,xhr:c}),this._notifyFileChanges(a)}}.bind(this);var g=new FormData;a.uploadTarget=this.target||'',a.formDataName=this.formDataName;var h=this.fire('upload-before',{file:a,xhr:c},{cancelable:!0});h.defaultPrevented||(g.append(a.formDataName,a,a.name),c.open(this.method,a.uploadTarget,!0),this._configureXhr(c),a.status=this.i18n.uploading.status.connecting,a.uploading=a.indeterminate=!0,a.complete=a.abort=a.error=!1,c.upload.onloadstart=function(){this.fire('upload-start',{file:a,xhr:c}),this._notifyFileChanges(a)}.bind(this),h=this.fire('upload-request',{file:a,xhr:c,formData:g},{cancelable:!0}),!h.defaultPrevented&&c.send(g))}},_retryFileUpload:function(a){var b=this.fire('upload-retry',{file:a,xhr:a.xhr},{cancelable:!0});b.defaultPrevented||this.async(this._uploadFile.bind(this,a))},_abortFileUpload:function(a){var b=this.fire('upload-abort',{file:a,xhr:a.xhr},{cancelable:!0});b.defaultPrevented||(a.abort=!0,a.xhr&&a.xhr.abort(),this._notifyFileChanges(a))},_notifyFileChanges:function(a){var b='files.'+this.files.indexOf(a)+'.';for(var c in a)a.hasOwnProperty(c)&&this.notifyPath(b+c,a[c])},_addFiles:function(a){Array.prototype.forEach.call(a,this._addFile.bind(this))},_addFile:function(a){if(this.maxFilesReached)return void this.fire('file-reject',{file:a,error:this.i18n.error.tooManyFiles});if(0<=this.maxFileSize&&a.size>this.maxFileSize)return void this.fire('file-reject',{file:a,error:this.i18n.error.fileIsTooBig});var b=a.name.match(/\.[^\.]*$|$/)[0],c=new RegExp('^('+this.accept.replace(/[, ]+/g,'|').replace(/\/\*/g,'/.*')+')$','i');return this.accept&&!(c.test(a.type)||c.test(b))?void this.fire('file-reject',{file:a,error:this.i18n.error.incorrectFileType}):void(a.loaded=0,a.status=this.i18n.uploading.status.held,this.unshift('files',a),!this.noAuto&&this._uploadFile(a))},_removeFile:function(a){this.splice('files',this.files.indexOf(a),1)},_onAddFilesClick:function(){Polymer.Gestures.resetMouseCanceller&&Polymer.Gestures.resetMouseCanceller(),this.$.fileInput.value='',this.$.fileInput.click()},_onFileInputChange:function(a){this._addFiles(a.target.files)},_onFileRetry:function(a){this._retryFileUpload(a.detail.file)},_onFileAbort:function(a){this._abortFileUpload(a.detail.file)},_onFileRemove:function(a){a.stopPropagation(),this._removeFile(a.detail.file)},_dragoverChanged:function(a){this.toggleAttribute('dragover',a)},_dragoverValidChanged:function(a){this.toggleAttribute('dragover-valid',a)},_i18nPlural:function(a,b){return 1===a?b.one:b.many},_isMultiple:function(){return 1!==this.maxFiles}});</script></body></html>