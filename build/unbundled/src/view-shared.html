<html><head><link rel="import" href="../bower_components/polymer/polymer.html"><link rel="import" href="../bower_components/vaadin-grid/vaadin-grid.html"><link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-sorter.html"><link rel="import" href="../bower_components/vaadin-grid/vaadin-grid-filter.html"><link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html"><link rel="import" href="../bower_components/iron-ajax/iron-ajax.html"><link rel="import" href="../bower_components/iron-icons/iron-icons.html"><link rel="import" href="../bower_components/paper-input/paper-input.html"><link rel="import" href="shared-styles.html"></head><body><dom-module id="view-shared"><template is="dom-bind"><style include="shared-styles" is="custom-style">:host{display:block;padding:10px;}iron-icon:hover{color:var(--app-primary-color);cursor:pointer;}</style><div class="card"><h1>Compartidos</h1><iron-ajax auto="" id="ajaxGet" url="[[backendURL]]/files/sharedWith/[[user.email]]" handle-as="json" on-response="handleResponse" on-error="handleError"></iron-ajax><iron-ajax id="ajaxDownload" method="GET" url="[[backendURI]]/download/[[activeItem._id]]/[[user.email]]" handle-as="blob" on-response="handleResponseDownload" on-error="handleError"></iron-ajax><iron-localstorage name="blinkboxUser" value="{{user}}" useraw="true" on-iron-localstorage-load-empty="initializeDefaultUser"></iron-localstorage><iron-localstorage name="blinkboxToken" value="{{token}}" useraw="true" on-iron-localstorage-load="loadStorage" on-iron-localstorage-load-empty="initializeDefaultToken"></iron-localstorage><template is="dom-if" if="[[ajaxError]]"><span>Error in url</span></template><vaadin-grid id="grid" items="[[ajaxResponse]]" multi-sort=""><vaadin-grid-column width="300px"><template class="header"><vaadin-grid-sorter path="name"><vaadin-grid-filter path="name" value="[[filterName]]"><paper-input placeholder="Nombre" value="{{filterName}}" focus-target=""></paper-input></vaadin-grid-filter></vaadin-grid-sorter></template><template>[[item.name]]</template></vaadin-grid-column><vaadin-grid-column width="150px"><template class="header"><vaadin-grid-sorter path="extension"><vaadin-grid-filter path="extension" value="[[filterExtension]]"><vaadin-combo-box label="Extensión" value="{{filterExtension}}" items="[[extensionsArray]]" allow-custom-value=""></vaadin-combo-box></vaadin-grid-filter></vaadin-grid-sorter></template><template>[[item.extension]]</template></vaadin-grid-column><vaadin-grid-column width="150px"><template class="header"><vaadin-grid-sorter path="size"><vaadin-grid-filter path="size" value="[[filterSize]]"><paper-input placeholder="Tamaño(Kb)" value="{{filterSize}}" focus-target=""></paper-input></vaadin-grid-filter></vaadin-grid-sorter></template><template>[[item.size]]</template></vaadin-grid-column><vaadin-grid-column width="150px"><template class="header"><vaadin-grid-sorter path="name"><vaadin-grid-filter path="owner_id" value="[[filterOwner]]"><paper-input placeholder="Dueño" value="{{filterOwner}}" focus-target=""></paper-input></vaadin-grid-filter></vaadin-grid-sorter></template><template>[[item.owner_id]]</template></vaadin-grid-column><vaadin-grid-column width="150px"><template class="header"><vaadin-grid-sorter path="expiring_date"><vaadin-grid-filter path="expiring_date" value="[[filterExpiringDate]]"><paper-input placeholder="Vencimiento" value="{{filterExpiringDate}}" focus-target=""></paper-input></vaadin-grid-filter></vaadin-grid-sorter></template><template>[[item.expiring_date]]</template></vaadin-grid-column><vaadin-grid-column><template class="header">Descarga</template><template><iron-icon icon="file-download" on-tap="handleTapDownload"></iron-icon></template></vaadin-grid-column><vaadin-grid-column><template class="header">Detalles</template><template><iron-icon icon="info" on-click="handleToggle"></iron-icon></template></vaadin-grid-column></vaadin-grid></div></template><script>Polymer({is:'view-shared',properties:{backendURL:{type:String},backendURI:{type:String,value:'http://127.0.0.1:4025/fileAccess'},user:Object,extensionsArray:{type:Array,value:[]},ajaxResponse:Object,ajaxError:Object,searchID:String,token:String},ready:function(){this.backendURL=this.backendUrl,this.searchID=this.queryParams.id},loadStorage:function(){''===this.token&&(location.href='/not-logged'),this.$.ajaxGet.headers.Authorization='Bearer '+this.token,this.$.ajaxDownload.headers.Authorization='Bearer '+this.token},handleResponse:function(a){if(!a.detail.response.shared_documents)return void this.fire('iron-signal',{name:'message-dialog',data:{error:'No se encontraron archivos'}});var b=a.detail.response.shared_documents;this.ajaxResponse=b.map(function(f){f.size=(f.size/1e3).toFixed(3);var g=new Date(1e3*f.expiring_date);return f.expiring_date=g.toISOString().split('T')[0],f});var c=this.ajaxResponse.reduce(function(f,g){return''!==g.extension&&(f[g.extension]=!0),f},{});if(this.extensionsArray=Object.keys(c),this.searchID){var d=this;this.activeItem=this.ajaxResponse.find(function(f){return f._id===d.searchID}),this.fire('iron-signal',{name:'file-info-dialog',data:{activeItem:this.activeItem}})}},handleToggle:function(a){a&&(this.activeItem=a.model.item),this.fire('iron-signal',{name:'file-info-dialog',data:{activeItem:this.activeItem}})},handleError:function(a){var b=a.detail.request,c=b.xhr,d=c.status+' : '+c.statusText;this.fire('iron-signal',{name:'message-dialog',data:{error:d}})},handleTapDownload:function(a){a&&(this.activeItem=a.model.item),this.$.ajaxDownload.generateRequest()},handleResponseDownload:function(a){var b=a.detail.response,c=URL.createObjectURL(b),d=document.createElement('a');d.href=c,d.download=this.activeItem.name,d.click()},initializeDefaultToken:function(){this.token=''},initializeDefaultUser:function(){this.user={id:'',firstName:'',lastName:'',email:'',exp_date:''}}});</script></dom-module></body></html>